<!DOCTYPE html>
<html lang="zh">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <title>
        
        

        
        
        如何讓 lazy_static 裏的靜態配置擁有「動態響應」能力？——記一次輸入法引擎的架構重構 |
        

        
        RIME | 中州韻輸入法引擎
    </title>

    
    <meta name="author" content="佛振@式恕堂">

    
    
    <meta name="description" content="Le blog de la Rime">
    

    
    
    <meta name="keywords" content="Rust, Leptos, 宮保粵拼, 並擊輸入, 拼寫運算, 狀態管理, 響應式編程, 開發實錄, 視頻">
    

    
    
    <meta property="og:title" content="如何讓 lazy_static 裏的靜態配置擁有「動態響應」能力？——記一次輸入法引擎的架構重構"/>
    
    <meta property="og:site_name" content="RIME | 中州韻輸入法引擎"/>

    
    

    
    
    <link rel="alternate" href="/atom.xml" title="RIME | 中州韻輸入法引擎" type="application/atom+xml">
    

    <link href="/favicon.png" rel="icon">

    
    <link rel="stylesheet" href="/css/bootstrap.flatly.min.css">
    <link rel="stylesheet" href="/css/font-awesome.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/darktheme.css">

    
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/jquery.cookie.js"></script>
    <script src="/js/jquery.t2s.js"></script>
    <script src="/js/modernizr.js"></script>
</head>

    <body>
        

<nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">切換導航菜單</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https:&#x2F;&#x2F;rime.im">RIME | 中州韻輸入法引擎</a>
      <button id="btn-simplify" type="button" class="navbar-convert">簡</button>
      <div class="collapse navbar-collapse nav-menu">
          <ul class="nav navbar-nav">
              
              <li>
                  <a href="&#x2F;download" title="">
                      <i class="fa fa-arrow-down"></i>下載
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;recipes" title="">
                      <i class="fa fa-flask"></i>配方
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;docs" title="">
                      <i class="fa fa-question-circle"></i>幫助
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;code" title="">
                      <i class="fa fa-github"></i>源碼
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;donate" title="">
                      <i class="fa fa-heart"></i>捐贈
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;discuss" title="">
                      <i class="fa fa-comments"></i>討論
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;blog" title="Rime::Blog">
                      <i class="fa fa-pencil-square-o"></i>網誌
                  </a>
              </li>
              
              <li>
                  <a href="&#x2F;online" title="">
                      <i class="fa fa-cloud"></i>體驗
                  </a>
              </li>
              
          </ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>


        
        
        <div class="container">
            <div class="content">
                
<div class="panel-heading">
    
    <div class="page-header">
        <h1>如何讓 lazy_static 裏的靜態配置擁有「動態響應」能力？——記一次輸入法引擎的架構重構</h1>
    </div>
</div>

<div class="row post">
    
    <div class="col-md-9">

        
        

        
        <div class="mypage">
            <p>大家好，前陣子我開源了一個爲 34 鍵分體鍵盤（Ferris Sweep）量身打造的粵拼並擊輸入法（宮保粵拼），並做了一個可視化的 Web 模擬器（基於 Rust + Leptos）。上一期發佈後，視覺效果不錯，但在底層架構上，我遇到了一個經典的 Rust 難題：如何讓編譯期就固定的靜態數據，根據前端的 UI 狀態進行動態切換？</p>
<h3 id="❌_痛點與挑戰">❌ 痛點與挑戰</h3>
<p>在 Rime 引擎的架構思維中，輸入方案（包含幾百條正則拼寫運算規則）通常是非常重的，所以我們習慣將其放在 <code>lazy_static!</code> 裏，擁有 <code>'static</code> 生命週期。</p>
<p>但我的需求是：當用戶在前端下拉選單切換「實體鍵盤佈局」（如標準直列 -&gt; 縱向錯列）時，底層的方案定義必須動態替換對應的指法規則。如果直接把前端的 <code>AppState</code> 塞進底層，會造成嚴重的耦合；如果每次切換都重新實例化整個方案，效能開銷又太大。</p>
<h3 id="✅_解法：依賴注入_(DI)_+_函數指針_+_Leptos_細粒度響應式追蹤">✅ 解法：依賴注入 (DI) + 函數指針 + Leptos 細粒度響應式追蹤</h3>
<p>經過一番折騰，我找到了一條非常優雅且符合 Rust 哲學的路徑：</p>
<span id="continue-reading"></span>
<ol>
<li>輕量級環境上下文</li>
</ol>
<p>我沒有把整個 <code>AppState</code> 傳給底層，而是抽取了一個全都是 <code>Copy</code> 屬性、包裝着 Leptos Signal 的環境結構體：</p>
<pre class="giallo" style="color-scheme: light dark; color: light-dark(#24292E, #E1E4E8); background-color: light-dark(#FFFFFF, #24292E);"><code data-lang="rust"><span class="giallo-l"><span>#</span><span>[</span><span>derive</span><span>(</span><span style="color: light-dark(#6F42C1, #B392F0);">Clone</span><span>,</span><span style="color: light-dark(#6F42C1, #B392F0);"> Copy</span><span>)</span><span>]</span></span>
<span class="giallo-l"><span style="color: light-dark(#D73A49, #F97583);">pub</span><span style="color: light-dark(#D73A49, #F97583);"> struct</span><span> 輸入方案環境 </span><span>{</span></span>
<span class="giallo-l"><span style="color: light-dark(#D73A49, #F97583);">    pub</span><span> 已選配列</span><span style="color: light-dark(#D73A49, #F97583);">:</span><span style="color: light-dark(#6F42C1, #B392F0);"> Signal</span><span>&lt;</span><span style="color: light-dark(#6F42C1, #B392F0);">Option</span><span>&lt;</span><span>配列</span><span>&gt;</span><span>&gt;</span><span>,</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<ol start="2">
<li>將靜態實例改爲生成函數</li>
</ol>
<p>我把 <code>lazy_static</code> 裏原本寫死的方案實例，改成了接收環境參數的函數指針 <code>fn(輸入方案環境) -&gt; 輸入方案定義&lt;'static&gt;</code>。
這完全沒有破壞 'static 的生命週期，只是把「組裝」的過程延遲到了執行期。</p>
<pre class="giallo" style="color-scheme: light dark; color: light-dark(#24292E, #E1E4E8); background-color: light-dark(#FFFFFF, #24292E);"><code data-lang="rust"><span class="giallo-l"><span style="color: light-dark(#6F42C1, #B392F0);">lazy_static!</span><span> {</span></span>
<span class="giallo-l"><span style="color: light-dark(#D73A49, #F97583);">    pub</span><span style="color: light-dark(#D73A49, #F97583);"> static</span><span style="color: light-dark(#D73A49, #F97583);"> ref</span><span> 方案選單</span><span style="color: light-dark(#D73A49, #F97583);">:</span><span style="color: light-dark(#6F42C1, #B392F0);"> Vec</span><span>&lt;</span><span>(</span><span>方案選項</span><span>,</span><span style="color: light-dark(#D73A49, #F97583);"> fn</span><span>(</span><span>輸入方案環境</span><span>)</span><span style="color: light-dark(#D73A49, #F97583);"> -&gt;</span><span> 輸入方案定義</span><span>&lt;</span><span>&#39;</span><span style="color: light-dark(#6F42C1, #B392F0);">static</span><span>&gt;</span><span>)</span><span>&gt;</span><span style="color: light-dark(#D73A49, #F97583);"> =</span><span style="color: light-dark(#6F42C1, #B392F0);"> vec!</span><span>[</span></span>
<span class="giallo-l"><span>        (</span><span>方案選項</span><span style="color: light-dark(#D73A49, #F97583);">::</span><span>宮保粵拼</span><span>,</span><span> 宮保粵拼輸入方案</span><span>)</span><span>,</span><span style="color: light-dark(#6A737D, #6A737D);"> //</span><span style="color: light-dark(#6A737D, #6A737D);"> 傳入函數指針</span></span>
<span class="giallo-l"><span style="color: light-dark(#6A737D, #6A737D);">        //</span><span style="color: light-dark(#6A737D, #6A737D);"> ...</span></span>
<span class="giallo-l"><span>    ]</span><span>;</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<ol start="3">
<li>在具體方案中攔截狀態，動態裝配</li>
</ol>
<p>外層的派發器變得極度「無腦」，只負責透傳 <code>環境</code>。只有真正關心硬件佈局的 <code>宮保粵拼</code> 模組，纔會在內部 讀取 Signal 的值（觸發依賴收集）。</p>
<p>這樣一來，外層的 <code>theory.rs</code> 只是在無腦透傳上下文，完全不與 UI 狀態耦合；而當用戶在前端切換佈局時，Leptos 的響應式系統會精準定位到這個具體的方案生成函數，自動觸發重新求值，完成動態裝配。</p>
<pre class="giallo" style="color-scheme: light dark; color: light-dark(#24292E, #E1E4E8); background-color: light-dark(#FFFFFF, #24292E);"><code data-lang="rust"><span class="giallo-l"><span style="color: light-dark(#D73A49, #F97583);">pub</span><span style="color: light-dark(#D73A49, #F97583);"> fn</span><span> 宮保粵拼輸入方案</span><span>(</span><span>環境</span><span style="color: light-dark(#D73A49, #F97583);">:</span><span> 輸入方案環境</span><span>)</span><span style="color: light-dark(#D73A49, #F97583);"> -&gt;</span><span> 輸入方案定義</span><span>&lt;</span><span>&#39;</span><span style="color: light-dark(#6F42C1, #B392F0);">static</span><span>&gt;</span><span> {</span></span>
<span class="giallo-l"><span style="color: light-dark(#D73A49, #F97583);">    let</span><span> 是縱版 </span><span style="color: light-dark(#D73A49, #F97583);">=</span><span style="color: light-dark(#6F42C1, #B392F0);"> matches!</span><span>(</span><span>環境</span><span style="color: light-dark(#D73A49, #F97583);">.</span><span>已選配列</span><span>(</span><span>)</span><span>,</span><span style="color: light-dark(#6F42C1, #B392F0);"> Some</span><span>(</span><span>配列</span><span style="color: light-dark(#D73A49, #F97583);">::</span><span>縱向錯列分體</span><span>)</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span style="color: light-dark(#6A737D, #6A737D);">    //</span><span style="color: light-dark(#6A737D, #6A737D);"> ... 動態回傳組裝好的結構體</span></span>
<span class="giallo-l"><span>}</span></span></code></pre><h3 id="🎉_成果">🎉 成果</h3>
<p>這套重構完美實現了「開閉原則（OCP）」。外層框架徹底與硬件佈局解耦，而前端 UI 只要一切換佈局，Leptos 的細粒度響應式系統就會自動觸發重新求值，指法提示瞬間切換！</p>
<p>這是我在 Rust 與前端框架結合上一次非常痛快的體驗，分享給各位。<a href="https://rime.im/blog/combo-jyutping-code-refactor/.">📺 開發實錄</a></p>
<p>如果你也對人體工學鍵盤或輸入法演算法感興趣，歡迎來看看這個專案：</p>
<p>💻 在線體驗：<a rel="external" href="https://rime.io/typewriter/">https://rime.io/typewriter/</a></p>
<p>📦 Rime 配方包：<a rel="external" href="https://github.com/lotem/rime-combo-jyutping">https://github.com/lotem/rime-combo-jyutping</a></p>

        </div>

        
        <center>
            <ul class="pagination">
                
                <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>後一篇</a></li>
                
                <li><a href="/blog"><i class="fa fa-book"></i>網誌</a></li>
                
                <li class="next"><a href="&#x2F;blog&#x2F;combo-jyutping-sweep-layout&#x2F;" class="alignright next">前一篇<i class="fa fa-arrow-circle-o-right"></i></a></li>
                
            </ul>
        </center>

        
        
        <section id="comment">
    <script src="https://giscus.app/client.js"
            data-repo="rime/home"
            data-repo-id="MDEwOlJlcG9zaXRvcnkzMTgwMzgxNA=="
            data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDQxODEx"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="preferred_color_scheme"
            data-lang="zh-CN"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
    </script>
</section>

        
    </div>

    
    <div class="col-md-3">

        
        
        <div class="meta-widget">
            <i class="fa fa-clock-o"></i>
            2026-02-26
        </div>
        <div>
            <a href="https:&#x2F;&#x2F;rime.im&#x2F;blog&#x2F;combo-jyutping-code-refactor&#x2F;#comment"><i class="fa fa-comments"></i> 留言</a>
        </div>
        

        
        
        <div class="meta-widget">
            <a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>
            <ul id="tags" class="tag_box list-unstyled collapse in">
                
                <li>
                    <a href="https://rime.im/tags/Rust/">
                        Rust
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/Leptos/">
                        Leptos
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/宮保粵拼/">
                        宮保粵拼
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/並擊輸入/">
                        並擊輸入
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/拼寫運算/">
                        拼寫運算
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/狀態管理/">
                        狀態管理
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/響應式編程/">
                        響應式編程
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/開發實錄/">
                        開發實錄
                    </a>
                </li>
                
                <li>
                    <a href="https://rime.im/tags/視頻/">
                        視頻
                    </a>
                </li>
                
            </ul>
        </div>
        

        
        
        
        <div class="meta-widget">
            <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
            <div id="toc" class="toc collapse in">
                
                <ol class="toc-article">
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;rime.im&#x2F;blog&#x2F;combo-jyutping-code-refactor&#x2F;#❌_痛點與挑戰">❌ 痛點與挑戰</a>
                        
                        
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;rime.im&#x2F;blog&#x2F;combo-jyutping-code-refactor&#x2F;#✅_解法：依賴注入_(DI)_+_函數指針_+_Leptos_細粒度響應式追蹤">✅ 解法：依賴注入 (DI) + 函數指針 + Leptos 細粒度響應式追蹤</a>
                        
                        
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;rime.im&#x2F;blog&#x2F;combo-jyutping-code-refactor&#x2F;#🎉_成果">🎉 成果</a>
                        
                        
                    </li>
                    
                </ol>
            </div>
        </div>
        

        <hr>
    </div>
</div>

            </div>
        </div>
        

        
<div class="container">
    <footer>
        <p>
            &copy; 2026 佛振@式恕堂
            &nbsp;
            <span class="text-muted">Powered by:
                <a class="text-muted" href="https://www.getzola.org/" target="_blank">Zola</a>,
                <a class="text-muted" href="http://github.com/yieme/hexo-theme-freewill/" target="_blank">Freewill</a>
                &amp;
                <a class="text-muted" href="http://bootswatch.com/" target="_blank">Bootswatch</a>
            </span>
        </p>
    </footer>
</div>

        <a id="gotop" href="#" style="display:none;"><span>▲</span></a>

<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>

    </body>
</html>
